<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SaltSync Report Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --ink:#0d0d14;--ink2:#1a1a28;--ink3:#252538;
  --surf:#f5f4ff;--surf2:#eeedf9;--surf3:#e5e3f5;
  --accent:#6c47ff;--accent2:#8b6aff;--accent3:#b09aff;
  --tl:#00c2a8;--tl2:#00e5c8;
  --gold:#f5a623;--red:#ff4466;--green:#00c87a;
  --white:#fff;--muted:#9090b0;
  --r:14px;--r2:20px;--r3:28px;
  --sh:0 4px 24px rgba(108,71,255,.13);
  --sh2:0 8px 40px rgba(108,71,255,.18);
  --tr:.22s cubic-bezier(.4,0,.2,1);
}
[data-theme="dark"]{
  --ink:#f0efff;--ink2:#d0cfee;--ink3:#b0afcc;
  --surf:#0f0f1c;--surf2:#16162a;--surf3:#1e1e38;
  --sh:0 4px 24px rgba(0,0,0,.4);--sh2:0 8px 40px rgba(0,0,0,.5);
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;background:var(--surf);color:var(--ink);min-height:100vh;transition:background var(--tr),color var(--tr);overflow-x:hidden}
h1,h2,h3,h4,h5{font-family:'Syne',sans-serif}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--surf2)}
::-webkit-scrollbar-thumb{background:var(--accent3);border-radius:99px}

/* â”€â”€ LOADER SCREEN â”€â”€ */
#bootScreen{position:fixed;inset:0;background:var(--ink2);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s}
.boot-logo{font-family:'Syne',sans-serif;font-size:2.4rem;font-weight:800;color:#fff;letter-spacing:-1px;margin-bottom:1.5rem}
.boot-logo span{color:var(--accent2)}
.boot-bar{width:220px;height:4px;background:rgba(255,255,255,.15);border-radius:99px;overflow:hidden}
.boot-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--tl));border-radius:99px;animation:bootFill 1.4s ease forwards}
@keyframes bootFill{from{width:0}to{width:100%}}
.boot-txt{margin-top:1rem;color:rgba(255,255,255,.5);font-size:.85rem}

/* â”€â”€ NAV â”€â”€ */
nav{position:fixed;top:0;left:0;right:0;height:60px;background:var(--surf);border-bottom:1.5px solid var(--surf3);display:flex;align-items:center;padding:0 1.5rem;gap:1rem;z-index:100;box-shadow:var(--sh)}
.nav-brand{font-family:'Syne',sans-serif;font-weight:800;font-size:1.25rem;color:var(--ink);text-decoration:none;flex:1}
.nav-brand span{color:var(--accent)}
.nav-pill{display:inline-flex;align-items:center;gap:.4rem;padding:.3rem .85rem;border-radius:99px;font-size:.78rem;font-weight:600;border:1.5px solid var(--surf3);color:var(--muted);transition:var(--tr)}
.nav-pill.connected{border-color:var(--green);color:var(--green);background:rgba(0,200,122,.08)}
.nav-pill.error{border-color:var(--red);color:var(--red);background:rgba(255,68,102,.08)}
.nav-dot{width:7px;height:7px;border-radius:50%;background:currentColor;animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.nav-btn{display:inline-flex;align-items:center;gap:.5rem;padding:.4rem 1rem;border-radius:99px;font-size:.85rem;font-weight:600;cursor:pointer;border:none;transition:var(--tr)}
.btn-ghost{background:transparent;border:1.5px solid var(--surf3);color:var(--ink)}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);background:rgba(108,71,255,.06)}
.btn-accent{background:var(--accent);color:#fff;box-shadow:var(--sh)}
.btn-accent:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:var(--sh2)}
.btn-tl{background:var(--tl);color:#fff;box-shadow:0 4px 20px rgba(0,194,168,.25)}
.btn-tl:hover{background:var(--tl2);transform:translateY(-1px)}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{opacity:.85;transform:translateY(-1px)}
.btn-green{background:var(--green);color:#fff}
.btn-green:hover{opacity:.85;transform:translateY(-1px)}

/* â”€â”€ NOTIF BANNER â”€â”€ */
#notifBanner{margin-top:60px;background:linear-gradient(90deg,var(--accent),var(--tl));color:#fff;text-align:center;padding:10px 1rem;font-size:.88rem;font-weight:500;letter-spacing:.2px}

/* â”€â”€ PAGE SYSTEM â”€â”€ */
.page{display:none;min-height:calc(100vh - 100px);padding:2rem 1rem 4rem}
.page.active{display:block;animation:pageIn .4s ease}
@keyframes pageIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.center-page{display:flex;align-items:center;justify-content:center;min-height:calc(100vh - 100px)}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--surf2);border:1.5px solid var(--surf3);border-radius:var(--r2);padding:2rem;box-shadow:var(--sh);transition:var(--tr)}
.card:hover{box-shadow:var(--sh2)}
.card-sm{padding:1.25rem 1.5rem;border-radius:var(--r)}
.card-glass{background:rgba(255,255,255,.06);backdrop-filter:blur(20px);border:1.5px solid rgba(255,255,255,.1)}

/* â”€â”€ DASHBOARD â”€â”€ */
.dash-hero{max-width:660px;margin:0 auto;text-align:center;padding:3rem 1.5rem}
.dash-title{font-size:2.6rem;font-weight:800;letter-spacing:-1.5px;line-height:1.15;margin-bottom:1rem}
.dash-title .grad{background:linear-gradient(135deg,var(--accent),var(--tl));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.dash-sub{color:var(--muted);font-size:1.05rem;margin-bottom:2.5rem}
.dash-cards{display:grid;grid-template-columns:1fr 1fr;gap:1rem;max-width:560px;margin:0 auto}
.dash-opt{background:var(--surf2);border:2px solid var(--surf3);border-radius:var(--r2);padding:2rem 1.5rem;cursor:pointer;transition:var(--tr);text-align:left;position:relative;overflow:hidden}
.dash-opt::after{content:'';position:absolute;inset:0;background:var(--accent);opacity:0;transition:opacity .3s}
.dash-opt:hover{border-color:var(--accent);transform:translateY(-5px);box-shadow:var(--sh2)}
.dash-opt:hover .opt-arrow{transform:translateX(4px)}
.dash-opt.tl-opt:hover{border-color:var(--tl)}
.dash-opt.tl-opt .opt-icon{color:var(--tl)}
.opt-icon{font-size:2rem;color:var(--accent);margin-bottom:1rem;display:block}
.opt-label{font-family:'Syne',sans-serif;font-weight:700;font-size:1.1rem;margin-bottom:.4rem}
.opt-desc{font-size:.85rem;color:var(--muted);line-height:1.5}
.opt-arrow{display:inline-flex;align-items:center;margin-top:1rem;font-size:.85rem;font-weight:600;color:var(--accent);gap:.3rem;transition:transform var(--tr)}
.tl-opt .opt-arrow{color:var(--tl)}

/* â”€â”€ FORMS â”€â”€ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.form-full{grid-column:1/-1}
.field{display:flex;flex-direction:column;gap:.45rem}
.field label{font-size:.85rem;font-weight:600;color:var(--ink2)}
.field input,.field select,.field textarea{background:var(--surf);border:1.5px solid var(--surf3);border-radius:var(--r);padding:.7rem 1rem;font-size:.92rem;color:var(--ink);font-family:'DM Sans',sans-serif;transition:var(--tr);outline:none;width:100%}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(108,71,255,.15)}
.field textarea{resize:vertical;min-height:110px;line-height:1.6}
.field select option{background:var(--surf2)}

/* â”€â”€ SECTION BLOCKS â”€â”€ */
.sec-block{border:1.5px solid var(--surf3);border-radius:var(--r2);padding:1.5rem;margin-bottom:1.25rem;background:var(--surf2);transition:var(--tr)}
.sec-block:hover{border-color:var(--accent3)}
.sec-block.tl-block{border-color:rgba(0,194,168,.3)}
.sec-block.tl-block:hover{border-color:var(--tl)}
.sec-title{font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;display:flex;align-items:center;gap:.5rem;margin-bottom:1rem;color:var(--ink)}
.sec-icon{width:30px;height:30px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-size:.8rem;background:rgba(108,71,255,.12);color:var(--accent);flex-shrink:0}
.tl-block .sec-icon{background:rgba(0,194,168,.12);color:var(--tl)}

/* â”€â”€ REPORT OUTPUT â”€â”€ */
.report-out{background:var(--ink2);color:#c8f0e8;border-radius:var(--r2);padding:1.75rem;font-family:'Courier New',monospace;font-size:.88rem;line-height:1.7;max-height:500px;overflow-y:auto;white-space:pre-wrap;border:1.5px solid var(--surf3);margin-top:1.5rem;display:none}
.report-out.show{display:block;animation:pageIn .4s ease}
.report-empty{text-align:center;padding:3rem;color:var(--muted);opacity:.6}
.report-empty i{font-size:3rem;margin-bottom:.8rem;display:block;opacity:.3}

/* â”€â”€ ADMIN LOGIN â”€â”€ */
.login-wrap{width:100%;max-width:420px;margin:0 auto}
.login-logo{font-family:'Syne',sans-serif;font-size:1.8rem;font-weight:800;text-align:center;margin-bottom:.5rem}
.login-sub{text-align:center;color:var(--muted);font-size:.9rem;margin-bottom:2rem}
.lock-icon{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;margin:0 auto 1.5rem;font-size:1.6rem;color:#fff;box-shadow:var(--sh2)}
.shake{animation:shake .4s ease}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}

/* â”€â”€ ADMIN PANEL â”€â”€ */
.admin-layout{max-width:1100px;margin:0 auto}
.admin-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:2rem;flex-wrap:wrap;gap:1rem}
.admin-title{font-size:1.7rem;font-weight:800;letter-spacing:-.5px}
.tab-row{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1.5px solid var(--surf3)}
.tab-btn{padding:.55rem 1.2rem;border-radius:99px;font-size:.85rem;font-weight:600;cursor:pointer;border:1.5px solid var(--surf3);background:transparent;color:var(--muted);transition:var(--tr)}
.tab-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:var(--sh)}
.tab-btn:hover:not(.active){border-color:var(--accent);color:var(--accent)}
.tab-panel{display:none}
.tab-panel.active{display:block;animation:pageIn .3s ease}

/* â”€â”€ STATS â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--surf2);border:1.5px solid var(--surf3);border-radius:var(--r2);padding:1.4rem;text-align:center;transition:var(--tr)}
.stat-card:hover{transform:translateY(-4px);box-shadow:var(--sh)}
.stat-num{font-family:'Syne',sans-serif;font-size:2.2rem;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--tl));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.stat-lbl{font-size:.8rem;color:var(--muted);margin-top:.3rem;font-weight:500}

/* â”€â”€ TABLE â”€â”€ */
.tbl-wrap{background:var(--surf2);border:1.5px solid var(--surf3);border-radius:var(--r2);overflow:hidden}
.search-bar{padding:1rem 1.25rem;border-bottom:1.5px solid var(--surf3);display:flex;gap:.75rem;align-items:center}
.search-bar input{flex:1;background:var(--surf);border:1.5px solid var(--surf3);border-radius:var(--r);padding:.55rem 1rem;font-size:.88rem;color:var(--ink);outline:none;transition:var(--tr)}
.search-bar input:focus{border-color:var(--accent)}
table{width:100%;border-collapse:collapse}
th{background:var(--surf3);color:var(--muted);font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:.85rem 1rem;text-align:left}
td{padding:.85rem 1rem;font-size:.88rem;border-bottom:1px solid var(--surf3);color:var(--ink)}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(108,71,255,.04)}
.badge{display:inline-block;padding:.25rem .7rem;border-radius:99px;font-size:.75rem;font-weight:700}
.badge-purple{background:rgba(108,71,255,.15);color:var(--accent)}
.badge-teal{background:rgba(0,194,168,.15);color:var(--tl)}
.badge-gold{background:rgba(245,166,35,.15);color:var(--gold)}
.badge-red{background:rgba(255,68,102,.15);color:var(--red)}
.badge-green{background:rgba(0,200,122,.15);color:var(--green)}
.badge-gray{background:var(--surf3);color:var(--muted)}

/* â”€â”€ EMP ITEM â”€â”€ */
.emp-item{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;background:var(--surf2);border:1.5px solid var(--surf3);border-radius:var(--r);margin-bottom:.6rem;transition:var(--tr)}
.emp-item:hover{border-color:var(--accent3);transform:translateX(3px)}
.emp-name{font-weight:600;font-size:.95rem}
.emp-id{font-size:.82rem;color:var(--muted);margin-top:.15rem}

/* â”€â”€ OVERVIEW ISSUES â”€â”€ */
.ov-item{display:flex;align-items:center;justify-content:space-between;padding:.85rem 1rem;border-radius:var(--r);margin-bottom:.5rem;border-left:3px solid var(--tl);background:rgba(0,194,168,.05);transition:var(--tr)}
.ov-item:hover{transform:translateX(4px)}
.ov-item.high{border-left-color:var(--gold);background:rgba(245,166,35,.06)}
.ov-item.critical{border-left-color:var(--red);background:rgba(255,68,102,.07)}
.ov-count{font-family:'Syne',sans-serif;font-weight:800;font-size:1rem;padding:.2rem .75rem;border-radius:99px;background:var(--tl);color:#fff}
.ov-count.high{background:var(--gold)}
.ov-count.critical{background:var(--red);animation:blink 1.5s infinite}

/* â”€â”€ CHIP / KEYWORD â”€â”€ */
.chip{display:inline-block;background:rgba(0,194,168,.1);color:var(--tl);padding:.2rem .6rem;border-radius:99px;font-size:.75rem;font-weight:600;margin:.15rem;border:1px solid rgba(0,194,168,.2);transition:var(--tr)}
.chip:hover{background:rgba(0,194,168,.2);transform:scale(1.04)}

/* â”€â”€ PHYS SUMMARY â”€â”€ */
.phys-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem;margin-top:1rem}
.phys-card{background:var(--surf);border:1.5px solid var(--surf3);border-radius:var(--r);padding:1rem;text-align:center}
.phys-val{font-family:'Syne',sans-serif;font-size:1.8rem;font-weight:800}
.phys-lbl{font-size:.75rem;color:var(--muted);margin-top:.2rem}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:500;display:none;align-items:center;justify-content:center;padding:1rem}
.modal-overlay.open{display:flex;animation:fadeIn .25s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-box{background:var(--surf2);border:1.5px solid var(--surf3);border-radius:var(--r3);padding:2.5rem;width:100%;max-width:700px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.5);animation:modalIn .3s ease}
@keyframes modalIn{from{transform:translateY(30px) scale(.97);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
.modal-close{position:absolute;top:1rem;right:1rem;background:var(--surf3);border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--muted);transition:var(--tr)}
.modal-close:hover{background:var(--red);color:#fff}
.modal-box pre{background:var(--ink2);color:#c8f0e8;padding:1.5rem;border-radius:var(--r);font-size:.82rem;line-height:1.7;white-space:pre-wrap;max-height:500px;overflow-y:auto}

/* â”€â”€ TOAST â”€â”€ */
#toastArea{position:fixed;bottom:1.5rem;right:1.5rem;z-index:9999;display:flex;flex-direction:column;gap:.5rem}
.toast-item{display:flex;align-items:center;gap:.75rem;padding:1rem 1.25rem;border-radius:var(--r2);font-size:.88rem;font-weight:500;box-shadow:0 8px 32px rgba(0,0,0,.3);animation:slideR .3s ease;min-width:260px;max-width:340px}
.toast-item.ok{background:var(--green);color:#fff}
.toast-item.err{background:var(--red);color:#fff}
.toast-item.info{background:var(--accent);color:#fff}
@keyframes slideR{from{transform:translateX(200px);opacity:0}to{transform:translateX(0);opacity:1}}

/* â”€â”€ LOADER â”€â”€ */
#loader{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);z-index:9998;display:none;align-items:center;justify-content:center}
#loader.on{display:flex}
.loader-card{background:var(--surf2);border-radius:var(--r2);padding:2rem 3rem;text-align:center;border:1.5px solid var(--surf3)}
.spinner{width:48px;height:48px;border:3px solid var(--surf3);border-top-color:var(--accent);border-radius:50%;animation:rot 1s linear infinite;margin:0 auto 1rem}
@keyframes rot{to{transform:rotate(360deg)}}

/* â”€â”€ EMPLOYEE PORTAL â”€â”€ */
.portal-card{background:var(--surf2);border:1.5px solid var(--surf3);border-radius:var(--r2);padding:2rem;margin-bottom:1rem;transition:var(--tr)}
.portal-card:hover{box-shadow:var(--sh);transform:translateY(-2px)}
.portal-report-date{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700}
.portal-meta{display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0}

/* â”€â”€ SETUP WIZARD â”€â”€ */
.sql-block{background:#0d0d14;color:#7dd3fc;border-radius:var(--r);padding:1.25rem;font-family:monospace;font-size:.78rem;line-height:1.7;overflow-x:auto;border:1px solid #1e1e38;margin:.75rem 0}
.sql-block .kw{color:#818cf8}.sql-block .str{color:#86efac}.sql-block .cm{color:#4b5563}
.step-num{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:var(--accent);color:#fff;font-weight:800;font-size:.82rem;flex-shrink:0;margin-right:.6rem}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:768px){
  .dash-cards{grid-template-columns:1fr}
  .stats-grid{grid-template-columns:1fr 1fr}
  .form-grid{grid-template-columns:1fr}
  .phys-grid{grid-template-columns:1fr 1fr}
  .admin-header{flex-direction:column;align-items:flex-start}
  .tab-row{gap:.35rem}
  .dash-title{font-size:1.9rem}
  nav{padding:0 1rem;gap:.5rem}
  .nav-btn span{display:none}
}
@media(max-width:480px){
  .stats-grid{grid-template-columns:1fr 1fr}
  .dash-title{font-size:1.5rem}
}
</style>
</head>
<body>

<!-- BOOT -->
<div id="bootScreen">
  <div class="boot-logo">Salt<span>Sync</span> Report</div>
  <div class="boot-bar"><div class="boot-fill"></div></div>
  <div class="boot-txt" id="bootTxt">Initializing cloud connectionâ€¦</div>
</div>

<!-- NAV -->
<nav>
  <a class="nav-brand" href="#" onclick="goTo('dashboard')">Salt<span>Sync</span> <span style="opacity:.4;font-size:.7rem;font-weight:400">Report Pro</span></a>
  <span class="nav-pill" id="cloudPill"><span class="nav-dot"></span> Connecting</span>
  <button class="nav-btn btn-ghost" onclick="toggleTheme()"><i class="fas fa-moon" id="themeIcon"></i></button>
  <button class="nav-btn btn-ghost" onclick="goTo('empPortal')"><i class="fas fa-user"></i> <span>My Reports</span></button>
  <button class="nav-btn btn-accent" onclick="showAdminGate()"><i class="fas fa-shield-halved"></i> <span>Admin</span></button>
</nav>

<!-- NOTIFICATION -->
<div id="notifBanner"><i class="fas fa-bell me-1"></i> <span id="notifTxt">Loadingâ€¦</span></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- SETUP -->
<div class="page center-page" id="pageSetup">
  <div style="max-width:700px;width:100%">
    <div class="card" style="margin-bottom:1rem">
      <h2 style="margin-bottom:.5rem"><i class="fas fa-database" style="color:var(--accent)"></i> Cloud Database Setup</h2>
      <p style="color:var(--muted);font-size:.9rem">Connect a free JSONBin.io database â€” no account required for testing, free tier works perfectly.</p>
    </div>

    <div class="card card-sm" style="margin-bottom:.75rem">
      <div style="display:flex;align-items:flex-start;gap:.8rem">
        <span class="step-num">1</span>
        <div>
          <div style="font-weight:700;margin-bottom:.3rem">Go to JSONBin.io and get a free API key</div>
          <div style="font-size:.85rem;color:var(--muted)">Visit <a href="https://jsonbin.io" target="_blank" style="color:var(--accent)">jsonbin.io</a> â†’ Sign up free â†’ Dashboard â†’ API Keys â†’ Create key. Copy the <b>Secret Key</b>.</div>
        </div>
      </div>
    </div>

    <div class="card card-sm" style="margin-bottom:.75rem">
      <div style="display:flex;align-items:flex-start;gap:.8rem">
        <span class="step-num">2</span>
        <div style="flex:1">
          <div style="font-weight:700;margin-bottom:.5rem">Paste your JSONBin API Key</div>
          <div class="field">
            <input type="password" id="cfgKey" placeholder="$2b$10$... (your secret key)">
          </div>
          <div style="font-size:.8rem;color:var(--muted);margin-top:.4rem">Your key is stored only in this browser. Reports go to your private JSONBin bins.</div>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:.75rem;flex-wrap:wrap">
      <button class="nav-btn btn-accent" style="flex:1;justify-content:center;padding:.8rem" onclick="setupCloud()"><i class="fas fa-plug"></i> Connect & Initialize</button>
      <button class="nav-btn btn-ghost" style="padding:.8rem 1.2rem" onclick="useLocal()"><i class="fas fa-hdd"></i> Use Local Only</button>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="page" id="pageDashboard">
  <div class="dash-hero">
    <div class="dash-title">Your Reports,<br><span class="grad">Everywhere.</span></div>
    <div class="dash-sub">Generate, save & track daily reports â€” synced to the cloud in real time.</div>
    <div class="dash-cards">
      <div class="dash-opt" onclick="goTo('empReport')">
        <i class="fas fa-clipboard-list opt-icon"></i>
        <div class="opt-label">Daily Issue Report</div>
        <div class="opt-desc">Employee daily log with issues, physical support & SS numbers.</div>
        <div class="opt-arrow">Start Report <i class="fas fa-arrow-right"></i></div>
      </div>
      <div class="dash-opt tl-opt" onclick="goTo('tlReport')">
        <i class="fas fa-chart-line opt-icon"></i>
        <div class="opt-label">Team Leader Report</div>
        <div class="opt-desc">Full shift overview â€” remote, physical, processing breakdown.</div>
        <div class="opt-arrow">Start Report <i class="fas fa-arrow-right"></i></div>
      </div>
    </div>
    <div style="margin-top:2rem;font-size:.82rem;color:var(--muted)"><i class="fas fa-cloud" style="margin-right:.3rem"></i>All data synced to cloud Â· Access from any device</div>
  </div>
</div>

<!-- EMPLOYEE REPORT -->
<div class="page" id="pageEmpReport">
  <div style="max-width:820px;margin:0 auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem">
      <div>
        <h2 style="letter-spacing:-.5px">Daily Issue Report</h2>
        <div style="font-size:.85rem;color:var(--muted)">Fill in the fields below and save to cloud</div>
      </div>
      <button class="nav-btn btn-ghost" onclick="goTo('dashboard')"><i class="fas fa-arrow-left"></i> Back</button>
    </div>
    <div class="card">
      <div class="form-grid">
        <div class="field"><label>Date</label><input type="date" id="eDate"></div>
        <div class="field"><label>Select Employee</label>
          <select id="eNameSel" onchange="fillEmp()"><option value="">â€” Loading employees â€”</option></select></div>
        <div class="field"><label>Employee Name</label><input type="text" id="eName" placeholder="Full name"></div>
        <div class="field"><label>Employee ID</label><input type="text" id="eId" placeholder="Salt-S-XXX" readonly style="opacity:.7"></div>
        <div class="field"><label>Duty Shift</label>
          <select id="eShift"><option value="">â€” Select â€”</option><option>Day</option><option>Evening</option><option>Night</option></select></div>
        <div class="field form-full"><label>Issues (one per line)</label><textarea id="eIssues" placeholder="Type each issue on a new lineâ€¦"></textarea></div>
      </div>

      <div class="sec-block" style="margin-top:1rem">
        <div class="sec-title"><span class="sec-icon"><i class="fas fa-hands-helping"></i></span>Physical Support Count</div>
        <div style="display:flex;align-items:center;gap:1rem">
          <input type="number" id="ePhys" value="0" min="0" style="width:100px;background:var(--surf);border:1.5px solid var(--surf3);border-radius:var(--r);padding:.6rem .8rem;font-size:1rem;color:var(--ink);outline:none" onchange="prevPhys()">
          <span style="font-size:.85rem;color:var(--muted)">Adds to total received & solved count automatically.</span>
        </div>
        <div id="physAlert"></div>
      </div>

      <div class="sec-block">
        <div class="sec-title"><span class="sec-icon"><i class="fas fa-list-ol"></i></span>SS Numbers / Processing</div>
        <textarea id="eSS" placeholder="Paste SS numbers here, one per lineâ€¦" style="background:var(--surf);border:1.5px solid var(--surf3);border-radius:var(--r);padding:.7rem 1rem;width:100%;color:var(--ink);outline:none;font-family:'DM Sans',sans-serif;resize:vertical;min-height:90px;transition:var(--tr)" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--surf3)'"></textarea>
      </div>

      <div class="sec-block">
        <div class="sec-title"><span class="sec-icon"><i class="fas fa-star"></i></span>Special Task / Note</div>
        <textarea id="eSpecial" placeholder="Any special accomplishments or notesâ€¦" style="background:var(--surf);border:1.5px solid var(--surf3);border-radius:var(--r);padding:.7rem 1rem;width:100%;color:var(--ink);outline:none;font-family:'DM Sans',sans-serif;resize:vertical;min-height:80px;transition:var(--tr)" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--surf3)'"></textarea>
      </div>

      <div style="display:flex;gap:.75rem;flex-wrap:wrap;justify-content:flex-end;margin-top:1.25rem">
        <button class="nav-btn btn-ghost" onclick="copyOut('eReportOut')"><i class="fas fa-copy"></i> Copy</button>
        <button class="nav-btn btn-accent" onclick="genEmpReport()"><i class="fas fa-cloud-upload-alt"></i> Generate & Save</button>
      </div>
      <div class="report-out" id="eReportOut"></div>
    </div>
  </div>
</div>

<!-- TL REPORT -->
<div class="page" id="pageTlReport">
  <div style="max-width:860px;margin:0 auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem">
      <div>
        <h2 style="letter-spacing:-.5px;color:var(--tl)">Team Leader Report</h2>
        <div style="font-size:.85rem;color:var(--muted)">Comprehensive shift report with full breakdown</div>
      </div>
      <button class="nav-btn btn-ghost" onclick="goTo('dashboard')"><i class="fas fa-arrow-left"></i> Back</button>
    </div>
    <div class="card">
      <div class="form-grid">
        <div class="field"><label>Date</label><input type="date" id="tDate"></div>
        <div class="field"><label>TL Name</label>
          <select id="tName"><option value="">â€” Select TL â€”</option><option>Safikul Islam</option><option>S.M Faisal</option></select></div>
        <div class="field form-full"><label>Report Shift</label>
          <select id="tShift"><option value="">â€” Select â€”</option>
            <option value="Day (9:00AM to 6:30PM)">Day (9:00AM to 6:30PM)</option>
            <option value="All Day (9:00AM to 9:00AM)">All Day (9:00AM to 9:00AM)</option>
            <option>Evening</option><option>Night</option></select></div>
        <div class="field form-full"><label>List of Issues (one per line)</label>
          <textarea id="tIssues" placeholder="Enter issuesâ€¦" oninput="updateOv()"></textarea></div>
      </div>

      <div class="sec-block tl-block" style="margin-top:1rem">
        <div class="sec-title"><span class="sec-icon"><i class="fas fa-users"></i></span>Processing Responsible Persons</div>
        <input type="text" id="tPersons" value="Sakib + labib + Sujan" style="background:var(--surf);border:1.5px solid var(--surf3);border-radius:var(--r);padding:.7rem 1rem;width:100%;color:var(--ink);outline:none;font-family:'DM Sans',sans-serif;transition:var(--tr)">
      </div>

      <div class="sec-block tl-block">
        <div class="sec-title" style="justify-content:space-between">
          <div style="display:flex;align-items:center;gap:.5rem"><span class="sec-icon"><i class="fas fa-chart-bar"></i></span>TL Overview</div>
          <span class="badge badge-gray" id="ovBadge">0 repeated</span>
        </div>
        <div id="tlOvList"><div style="text-align:center;padding:1.5rem;color:var(--muted);font-size:.88rem">Start typing issues above to see overview</div></div>
        <div style="margin-top:1rem;padding:1rem;background:rgba(0,194,168,.05);border-radius:var(--r);border-left:3px solid var(--tl)">
          <div style="font-size:.82rem;font-weight:700;margin-bottom:.5rem;color:var(--tl)"><i class="fas fa-tags"></i> Issue Categories</div>
          <div id="kw"></div>
        </div>
      </div>

      <div class="sec-block">
        <div class="sec-title"><span class="sec-icon"><i class="fas fa-tools"></i></span>Physical Support Issues</div>
        <textarea id="tPhys" placeholder="ONT replacement - done&#10;Fiber splicing - shift&#10;Router setup - cancel" oninput="updatePhysPrev()"></textarea>
        <div style="font-size:.8rem;color:var(--muted);margin-top:.4rem">done/fixed/solved â†’ Complete &bull; shift/pending â†’ Shift &bull; cancel â†’ Cancel</div>
        <div id="physPrev" style="display:none;margin-top:.75rem">
          <div class="phys-grid" id="physGrid"></div>
        </div>
      </div>

      <div class="sec-block tl-block">
        <div class="sec-title"><span class="sec-icon"><i class="fas fa-list-ol"></i></span>SS Numbers / Processing</div>
        <textarea id="tSS" placeholder="Paste SS numbers hereâ€¦" style="background:var(--surf);border:1.5px solid var(--surf3);border-radius:var(--r);padding:.7rem 1rem;width:100%;color:var(--ink);outline:none;font-family:'DM Sans',sans-serif;resize:vertical;min-height:90px;transition:var(--tr)" onfocus="this.style.borderColor='var(--tl)'" onblur="this.style.borderColor='var(--surf3)'"></textarea>
      </div>

      <div style="display:flex;gap:.75rem;flex-wrap:wrap;justify-content:flex-end;margin-top:1.25rem">
        <button class="nav-btn btn-ghost" onclick="copyOut('tReportOut')"><i class="fas fa-copy"></i> Copy</button>
        <button class="nav-btn btn-tl" onclick="genTLReport()"><i class="fas fa-cloud-upload-alt"></i> Generate & Save</button>
      </div>
      <div class="report-out" id="tReportOut"></div>
    </div>
  </div>
</div>

<!-- EMPLOYEE PORTAL -->
<div class="page" id="pageEmpPortal">
  <div style="max-width:860px;margin:0 auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem">
      <div><h2>My Reports</h2><div style="font-size:.85rem;color:var(--muted)">View your personal report history from cloud</div></div>
      <button class="nav-btn btn-ghost" onclick="goTo('dashboard')"><i class="fas fa-arrow-left"></i> Back</button>
    </div>
    <div class="card card-sm" style="margin-bottom:1rem">
      <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap">
        <div class="field" style="flex:1;min-width:200px"><label>Select Your Name</label>
          <select id="portalName" onchange="loadPortal()"><option value="">â€” Select your name â€”</option></select></div>
        <div style="align-self:flex-end">
          <button class="nav-btn btn-accent" onclick="loadPortal()"><i class="fas fa-sync"></i> Refresh</button>
        </div>
      </div>
    </div>
    <div id="portalList"><div class="report-empty"><i class="fas fa-user-circle"></i><p>Select your name to view reports</p></div></div>
  </div>
</div>

<!-- ADMIN GATE (LOGIN) -->
<div class="page center-page" id="pageAdminGate">
  <div class="login-wrap">
    <div class="lock-icon" id="lockIcon"><i class="fas fa-lock"></i></div>
    <div class="login-logo">Admin Access</div>
    <div class="login-sub">Enter your password to continue</div>
    <div class="card">
      <div class="field" style="margin-bottom:1rem">
        <label>Password</label>
        <input type="password" id="adminPassInput" placeholder="Enter admin password" onkeydown="if(event.key==='Enter')tryLogin()">
      </div>
      <div id="loginErr" style="color:var(--red);font-size:.85rem;margin-bottom:.75rem;display:none"><i class="fas fa-exclamation-triangle"></i> <span id="loginErrTxt"></span></div>
      <button class="nav-btn btn-accent" style="width:100%;justify-content:center;padding:.85rem" onclick="tryLogin()"><i class="fas fa-unlock"></i> Login</button>
      <button class="nav-btn btn-ghost" style="width:100%;justify-content:center;margin-top:.5rem;padding:.7rem" onclick="goTo('dashboard')">Cancel</button>
      <div style="text-align:center;margin-top:1rem;font-size:.78rem;color:var(--muted)">Default password: <code style="color:var(--accent)">admin</code></div>
    </div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div class="page" id="pageAdmin">
  <div class="admin-layout">
    <div class="admin-header">
      <h2 class="admin-title"><i class="fas fa-shield-halved" style="color:var(--accent)"></i> Admin Panel</h2>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="nav-btn btn-ghost" onclick="goTo('dashboard')"><i class="fas fa-arrow-left"></i> Dashboard</button>
        <button class="nav-btn btn-danger" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-num" id="st0">0</div><div class="stat-lbl">Employee Reports</div></div>
      <div class="stat-card"><div class="stat-num" id="st1">0</div><div class="stat-lbl">TL Reports</div></div>
      <div class="stat-card"><div class="stat-num" id="st2">0</div><div class="stat-lbl">Total Issues</div></div>
      <div class="stat-card"><div class="stat-num" id="st3">0</div><div class="stat-lbl">Issues Solved</div></div>
    </div>

    <!-- Tabs -->
    <div class="tab-row">
      <button class="tab-btn active" onclick="switchTab('tEmpRep')"><i class="fas fa-users"></i> Employee Reports</button>
      <button class="tab-btn" onclick="switchTab('tTLRep')"><i class="fas fa-user-check"></i> TL Reports</button>
      <button class="tab-btn" onclick="switchTab('tEmps')"><i class="fas fa-users-cog"></i> Manage Employees</button>
      <button class="tab-btn" onclick="switchTab('tNotif')"><i class="fas fa-bell"></i> Notification</button>
      <button class="tab-btn" onclick="switchTab('tDB')"><i class="fas fa-database"></i> Database</button>
      <button class="tab-btn" onclick="switchTab('tPwd')"><i class="fas fa-key"></i> Security</button>
    </div>

    <!-- TAB: Employee Reports -->
    <div class="tab-panel active" id="tEmpRep">
      <div class="tbl-wrap">
        <div class="search-bar"><i class="fas fa-search" style="color:var(--muted)"></i><input id="empSearch" placeholder="Search by name or dateâ€¦" oninput="filterEmpTable()"></div>
        <div style="overflow-x:auto">
        <table><thead><tr><th>Date</th><th>Employee</th><th>Shift</th><th>Issues</th><th>Solved</th><th>Physical</th><th>Special</th><th>Actions</th></tr></thead>
        <tbody id="empTBody"><tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--muted)"><div class="spinner" style="width:32px;height:32px;margin:0 auto"></div></td></tr></tbody></table>
        </div>
      </div>
    </div>

    <!-- TAB: TL Reports -->
    <div class="tab-panel" id="tTLRep">
      <div class="tbl-wrap">
        <div class="search-bar"><i class="fas fa-search" style="color:var(--muted)"></i><input id="tlSearch" placeholder="Search by TL name or dateâ€¦" oninput="filterTLTable()"></div>
        <div style="overflow-x:auto">
        <table><thead><tr><th>Date</th><th>TL</th><th>Shift</th><th>Issues</th><th>Solved</th><th>Physical</th><th>Processing</th><th>Actions</th></tr></thead>
        <tbody id="tlTBody"><tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--muted)"><div class="spinner" style="width:32px;height:32px;margin:0 auto"></div></td></tr></tbody></table>
        </div>
      </div>
    </div>

    <!-- TAB: Manage Employees -->
    <div class="tab-panel" id="tEmps">
      <div class="card" style="margin-bottom:1rem">
        <h4 style="margin-bottom:1rem"><i class="fas fa-user-plus" style="color:var(--accent)"></i> Add Employee</h4>
        <div style="display:flex;gap:.75rem;flex-wrap:wrap">
          <div class="field" style="flex:2;min-width:180px"><label>Full Name</label><input id="newEName" placeholder="e.g. Md Arif Hossain"></div>
          <div class="field" style="flex:1;min-width:140px"><label>Employee ID</label><input id="newEId" placeholder="e.g. Salt-S-100"></div>
          <div style="align-self:flex-end"><button class="nav-btn btn-green" onclick="addEmployee()"><i class="fas fa-plus"></i> Add</button></div>
        </div>
      </div>
      <div class="card">
        <h4 style="margin-bottom:1rem"><i class="fas fa-list" style="color:var(--accent)"></i> Current Employees</h4>
        <div id="empList"></div>
      </div>
    </div>

    <!-- TAB: Notification -->
    <div class="tab-panel" id="tNotif">
      <div class="card">
        <h4 style="margin-bottom:.5rem"><i class="fas fa-bell" style="color:var(--accent)"></i> Notification Banner</h4>
        <p style="color:var(--muted);font-size:.88rem;margin-bottom:1rem">This message appears at the top for all users.</p>
        <div class="field"><label>Message Text</label><textarea id="notifInput" rows="3" placeholder="Enter notification textâ€¦"></textarea></div>
        <div style="margin-top:1rem;display:flex;gap:.75rem">
          <button class="nav-btn btn-accent" onclick="saveNotif()"><i class="fas fa-save"></i> Save & Publish</button>
          <button class="nav-btn btn-ghost" onclick="previewNotif()"><i class="fas fa-eye"></i> Preview</button>
        </div>
      </div>
    </div>

    <!-- TAB: Database -->
    <div class="tab-panel" id="tDB">
      <div class="card">
        <h4 style="margin-bottom:1rem"><i class="fas fa-database" style="color:var(--accent)"></i> Database Configuration</h4>
        <div style="display:grid;gap:.75rem;margin-bottom:1.5rem">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:.85rem 1rem;background:var(--surf);border-radius:var(--r);border:1px solid var(--surf3)">
            <span style="font-weight:600;font-size:.9rem">Status</span>
            <span class="badge" id="dbStatusBadge">â€”</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:.85rem 1rem;background:var(--surf);border-radius:var(--r);border:1px solid var(--surf3)">
            <span style="font-weight:600;font-size:.9rem">Storage Mode</span>
            <span class="badge badge-purple" id="dbModeBadge">â€”</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:.85rem 1rem;background:var(--surf);border-radius:var(--r);border:1px solid var(--surf3)">
            <span style="font-weight:600;font-size:.9rem">Total Reports</span>
            <span class="badge badge-purple" id="dbCountBadge">â€”</span>
          </div>
        </div>
        <div class="field" style="margin-bottom:1rem">
          <label>JSONBin API Key (to reconfigure)</label>
          <input type="password" id="newCfgKey" placeholder="Paste new key to replace existing">
        </div>
        <div style="display:flex;gap:.75rem;flex-wrap:wrap">
          <button class="nav-btn btn-accent" onclick="reconnectDB()"><i class="fas fa-plug"></i> Reconnect</button>
          <button class="nav-btn btn-danger" onclick="clearConfig()"><i class="fas fa-trash-alt"></i> Clear Config (go to setup)</button>
        </div>
      </div>
    </div>

    <!-- TAB: Security -->
    <div class="tab-panel" id="tPwd">
      <div class="card">
        <h4 style="margin-bottom:.5rem"><i class="fas fa-key" style="color:var(--accent)"></i> Change Admin Password</h4>
        <p style="color:var(--muted);font-size:.88rem;margin-bottom:1rem">Default password is <code style="color:var(--accent)">admin</code>. Change it immediately.</p>
        <div class="form-grid" style="margin-bottom:1rem">
          <div class="field"><label>Current Password</label><input type="password" id="curPwd" placeholder="Current password"></div>
          <div style="display:none"></div>
          <div class="field"><label>New Password</label><input type="password" id="newPwd" placeholder="New password (min 4 chars)"></div>
          <div class="field"><label>Confirm New Password</label><input type="password" id="newPwd2" placeholder="Repeat new password"></div>
        </div>
        <button class="nav-btn btn-accent" onclick="changePwd()"><i class="fas fa-save"></i> Update Password</button>
        <hr style="margin:1.5rem 0;border-color:var(--surf3)">
        <h4 style="margin-bottom:.5rem"><i class="fas fa-undo" style="color:var(--gold)"></i> Reset to Default</h4>
        <p style="color:var(--muted);font-size:.88rem;margin-bottom:1rem">Resets admin password back to <code style="color:var(--accent)">admin</code>. Use if locked out.</p>
        <button class="nav-btn btn-ghost" onclick="resetPwd()"><i class="fas fa-undo"></i> Reset to "admin"</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL (view report) -->
<div class="modal-overlay" id="reportModal" onclick="closeModal(event)">
  <div class="modal-box" style="position:relative">
    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
    <h4 style="margin-bottom:1rem"><i class="fas fa-file-alt" style="color:var(--accent)"></i> Report Details</h4>
    <pre id="modalContent"></pre>
    <div style="display:flex;gap:.75rem;margin-top:1rem">
      <button class="nav-btn btn-accent" onclick="copyModalContent()"><i class="fas fa-copy"></i> Copy</button>
    </div>
  </div>
</div>

<!-- LOADER -->
<div id="loader"><div class="loader-card"><div class="spinner"></div><div id="loaderTxt" style="font-weight:600">Processingâ€¦</div></div></div>

<!-- TOAST -->
<div id="toastArea"></div>

<script>
// =====================================================
// CONSTANTS & STATE
// =====================================================
const PASS_KEY = 'srp_admin_pass';
const CFG_KEY  = 'srp_cfg';
const LOCAL_KEY = 'srp_local';
const BIN_API  = 'https://api.jsonbin.io/v3';

let db = {
  empBin: null, tlBin: null, empsBin: null, settingsBin: null,
  apiKey: null, mode: 'local'
};
let isAdmin = false;
let empCache = {};
let allEmpReports = [];
let allTLReports  = [];

const FIXED = {
  'Slow Issues':['slow','slow internet','speed issue','slow speed'],
  'Direct Call':['direct call'],'QC Call':['qc call'],
  'Solved':['solved','done','fixed'],
  'Billing Issues':['billing','bill','payment','invoice'],
  'No Internet':['no internet','internet down','offline'],
  'Disconnect Issue':['disconnect','disconnected'],
  'Loss':['loss','packet loss'],
  'Pack Change':['pack update','pack upgrade','pack downgrade','package change'],
  'Power Check':['power','power check'],'Shifting':['shifting','relocation'],
  'Site Browsing Issue':['site issue','website problem','browsing issue'],
  'Gaming Issue':['game','gaming','ping','latency'],'General Task':['general'],
  'Reconnection':['reconnect','reconnection'],'New Line':['new line','new connection'],
  'Public IP Need':['public ip'],'FTP Issue':['ftp'],'Info':['info','information']
};

const DEFAULT_EMPS = [
  {name:"Sujan Tarafdar",id:"Salt-S-063"},
  {name:"Md Safikul Islam",id:"Salt-S-076"},
  {name:"Sajid Hossain",id:"Salt-S-077"},
  {name:"Md. Shamsur Rahman",id:"Salt-S-049"},
  {name:"Md. Muhaimin Nabi",id:"Salt-S-094"},
  {name:"Rony Bine",id:"Salt-S-096"},
  {name:"MD Shakib",id:"Salt-S-080"},
  {name:"GM Sakib",id:"Salt-S-087"}
];

// =====================================================
// BOOT
// =====================================================
window.onload = async () => {
  loadTheme();
  updateBootTxt('Checking configurationâ€¦');

  const cfg = getCfg();
  const localMode = localStorage.getItem(LOCAL_KEY) === '1';

  if (!cfg && !localMode) {
    finishBoot(); goTo('setup'); setPill('err','Setup needed'); return;
  }

  if (cfg) {
    db.apiKey = cfg.key;
    db.empBin = cfg.empBin;
    db.tlBin  = cfg.tlBin;
    db.empsBin = cfg.empsBin;
    db.settingsBin = cfg.settingsBin;
    db.mode = 'cloud';
    updateBootTxt('Loading cloud dataâ€¦');
    try {
      await refreshEmpCache();
      await loadNotif();
      setPill('ok','Cloud Connected');
    } catch(e) {
      setPill('err','Cloud Error');
      toast('Cloud error: ' + e.message, 'err');
    }
  } else {
    db.mode = 'local';
    setPill('','Local Mode');
    loadLocalEmps();
    loadLocalNotif();
  }

  populateKw();
  finishBoot();
  goTo('dashboard');
};

function updateBootTxt(t){ document.getElementById('bootTxt').textContent = t; }
function finishBoot(){
  setTimeout(()=>{
    const b = document.getElementById('bootScreen');
    b.style.opacity = '0';
    setTimeout(()=>b.style.display='none', 500);
  }, 1600);
}

// =====================================================
// CONFIG
// =====================================================
function getCfg(){ try{ return JSON.parse(localStorage.getItem(CFG_KEY)); }catch{return null;} }
function getAdminPass(){ return localStorage.getItem(PASS_KEY) || 'admin'; }

// =====================================================
// JSONBIN HELPERS
// =====================================================
async function jbCreate(data){
  const r = await fetch(`${BIN_API}/b`, {
    method:'POST',
    headers:{'Content-Type':'application/json','X-Master-Key':db.apiKey,'X-Bin-Private':'false'},
    body: JSON.stringify(data)
  });
  if(!r.ok) throw new Error(`Create bin failed: ${r.status}`);
  const j = await r.json();
  return j.metadata.id;
}

async function jbRead(binId){
  const r = await fetch(`${BIN_API}/b/${binId}/latest`, {
    headers:{'X-Master-Key':db.apiKey}
  });
  if(!r.ok) throw new Error(`Read bin failed: ${r.status}`);
  const j = await r.json();
  return j.record;
}

async function jbWrite(binId, data){
  const r = await fetch(`${BIN_API}/b/${binId}`, {
    method:'PUT',
    headers:{'Content-Type':'application/json','X-Master-Key':db.apiKey},
    body: JSON.stringify(data)
  });
  if(!r.ok) throw new Error(`Write bin failed: ${r.status}`);
}

// =====================================================
// SETUP
// =====================================================
async function setupCloud(){
  const key = g('cfgKey').trim();
  if(!key){ toast('Please enter your JSONBin API key','err'); return; }
  load('Creating cloud storage binsâ€¦');
  try {
    db.apiKey = key;
    // Create 4 bins
    const empBin      = await jbCreate({reports:[]});
    const tlBin       = await jbCreate({reports:[]});
    const empsBin     = await jbCreate({employees: DEFAULT_EMPS});
    const settingsBin = await jbCreate({notification:'Welcome to SaltSync Report Pro! ðŸŽ‰', adminPass:'admin'});

    const cfg = {key, empBin, tlBin, empsBin, settingsBin};
    localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
    localStorage.removeItem(LOCAL_KEY);
    hideLoad();
    toast('Cloud connected! Reloadingâ€¦');
    setTimeout(()=>location.reload(), 1200);
  } catch(e) {
    hideLoad();
    toast('Setup failed: ' + e.message, 'err');
  }
}

function useLocal(){
  localStorage.setItem(LOCAL_KEY,'1');
  localStorage.removeItem(CFG_KEY);
  location.reload();
}

// =====================================================
// DATA LAYER â€” EMPLOYEES
// =====================================================
async function refreshEmpCache(){
  if(db.mode==='cloud'){
    const d = await jbRead(db.empsBin);
    empCache = {};
    (d.employees||[]).forEach(e=>{ empCache[e.name]=e.id; });
  } else {
    loadLocalEmps();
  }
}

function loadLocalEmps(){
  try{ empCache = JSON.parse(localStorage.getItem('srp_emps')||'{}'); }catch{ empCache={}; }
  if(!Object.keys(empCache).length){
    DEFAULT_EMPS.forEach(e=>{ empCache[e.name]=e.id; });
    saveLocalEmps();
  }
}

function saveLocalEmps(){
  localStorage.setItem('srp_emps', JSON.stringify(empCache));
}

async function addEmpToDB(name, id){
  if(db.mode==='cloud'){
    const d = await jbRead(db.empsBin);
    d.employees = d.employees || [];
    if(d.employees.find(e=>e.name===name)) throw new Error('Employee already exists');
    d.employees.push({name,id});
    await jbWrite(db.empsBin, d);
  } else {
    if(empCache[name]) throw new Error('Employee already exists');
    empCache[name]=id; saveLocalEmps();
  }
  empCache[name]=id;
}

async function removeEmpFromDB(name){
  if(db.mode==='cloud'){
    const d = await jbRead(db.empsBin);
    d.employees = (d.employees||[]).filter(e=>e.name!==name);
    await jbWrite(db.empsBin, d);
  } else {
    delete empCache[name]; saveLocalEmps();
  }
  delete empCache[name];
}

// =====================================================
// DATA LAYER â€” REPORTS
// =====================================================
async function saveEmpReport(report){
  if(db.mode==='cloud'){
    const d = await jbRead(db.empBin);
    d.reports = d.reports||[];
    report.id = Date.now().toString()+Math.random().toString(36).slice(2,6);
    d.reports.unshift(report);
    await jbWrite(db.empBin, d);
  } else {
    const arr = getLocal('srp_emp_rep');
    report.id = Date.now().toString()+Math.random().toString(36).slice(2,6);
    arr.unshift(report);
    saveLocal('srp_emp_rep', arr);
  }
}

async function saveTLReport(report){
  if(db.mode==='cloud'){
    const d = await jbRead(db.tlBin);
    d.reports = d.reports||[];
    report.id = Date.now().toString()+Math.random().toString(36).slice(2,6);
    d.reports.unshift(report);
    await jbWrite(db.tlBin, d);
  } else {
    const arr = getLocal('srp_tl_rep');
    report.id = Date.now().toString()+Math.random().toString(36).slice(2,6);
    arr.unshift(report);
    saveLocal('srp_tl_rep', arr);
  }
}

async function fetchAllEmpReports(){
  if(db.mode==='cloud'){ const d=await jbRead(db.empBin); return d.reports||[]; }
  return getLocal('srp_emp_rep');
}

async function fetchAllTLReports(){
  if(db.mode==='cloud'){ const d=await jbRead(db.tlBin); return d.reports||[]; }
  return getLocal('srp_tl_rep');
}

async function deleteReport(type, id){
  if(db.mode==='cloud'){
    const binId = type==='emp'?db.empBin:db.tlBin;
    const d = await jbRead(binId);
    d.reports = (d.reports||[]).filter(r=>r.id!==id);
    await jbWrite(binId,d);
  } else {
    const key = type==='emp'?'srp_emp_rep':'srp_tl_rep';
    saveLocal(key, getLocal(key).filter(r=>r.id!==id));
  }
}

// =====================================================
// DATA LAYER â€” SETTINGS (Notification & Admin Pass)
// =====================================================
async function getSettings(){
  if(db.mode==='cloud'){ return await jbRead(db.settingsBin); }
  return {
    notification: localStorage.getItem('srp_notif')||'Welcome to SaltSync Report Pro! ðŸŽ‰',
    adminPass: getAdminPass()
  };
}

async function saveSettings(patch){
  if(db.mode==='cloud'){
    const d = await jbRead(db.settingsBin);
    Object.assign(d, patch);
    await jbWrite(db.settingsBin, d);
  }
  if(patch.notification) localStorage.setItem('srp_notif', patch.notification);
  if(patch.adminPass)    localStorage.setItem(PASS_KEY, patch.adminPass);
}

// =====================================================
// NOTIFICATION
// =====================================================
async function loadNotif(){
  const s = await getSettings();
  document.getElementById('notifTxt').textContent = s.notification || 'Welcome!';
  // Also sync admin pass from cloud
  if(s.adminPass) localStorage.setItem(PASS_KEY, s.adminPass);
}

function loadLocalNotif(){
  document.getElementById('notifTxt').textContent =
    localStorage.getItem('srp_notif') || 'Welcome to SaltSync Report Pro! ðŸŽ‰';
}

// =====================================================
// NAVIGATION
// =====================================================
const PAGES = {
  setup:'pageSetup', dashboard:'pageDashboard', empReport:'pageEmpReport',
  tlReport:'pageTlReport', empPortal:'pageEmpPortal',
  adminGate:'pageAdminGate', admin:'pageAdmin'
};

function goTo(name){
  Object.values(PAGES).forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.classList.remove('active'); el.style.display='none'; }
  });
  const pg = document.getElementById(PAGES[name]);
  if(!pg) return;
  pg.style.display = ['setup','adminGate'].includes(name) ? 'flex' : 'block';
  setTimeout(()=>pg.classList.add('active'),10);

  if(name==='empReport') initEmpForm();
  if(name==='tlReport')  initTLForm();
  if(name==='empPortal') initPortal();
  if(name==='admin') loadAdminPanel();
}

function showAdminGate(){
  if(isAdmin){ goTo('admin'); return; }
  document.getElementById('adminPassInput').value='';
  document.getElementById('loginErr').style.display='none';
  goTo('adminGate');
}

function adminLogout(){
  isAdmin=false;
  toast('Logged out successfully','info');
  goTo('dashboard');
}

// =====================================================
// ADMIN LOGIN (STRONG)
// =====================================================
function tryLogin(){
  const pass = document.getElementById('adminPassInput').value;
  const correct = getAdminPass();
  if(pass === correct){
    isAdmin = true;
    document.getElementById('lockIcon').innerHTML='<i class="fas fa-unlock"></i>';
    document.getElementById('lockIcon').style.background='linear-gradient(135deg,var(--green),var(--tl))';
    toast('Welcome, Admin!');
    setTimeout(()=>{ goTo('admin'); resetLockIcon(); }, 600);
  } else {
    document.getElementById('loginErr').style.display='block';
    document.getElementById('loginErrTxt').textContent='Wrong password. Try again.';
    document.getElementById('adminPassInput').value='';
    const card=document.querySelector('.login-wrap .card');
    card.classList.add('shake');
    setTimeout(()=>card.classList.remove('shake'),400);
    document.getElementById('lockIcon').style.background='linear-gradient(135deg,var(--red),#ff7090)';
    setTimeout(()=>resetLockIcon(),1000);
  }
}

function resetLockIcon(){
  document.getElementById('lockIcon').innerHTML='<i class="fas fa-lock"></i>';
  document.getElementById('lockIcon').style.background='linear-gradient(135deg,var(--accent),var(--accent2))';
}

// =====================================================
// EMPLOYEE REPORT FORM
// =====================================================
async function initEmpForm(){
  document.getElementById('eDate').valueAsDate = new Date();
  const out = document.getElementById('eReportOut');
  out.classList.remove('show'); out.style.display='none';
  await refreshEmpCache();
  const sel = document.getElementById('eNameSel');
  sel.innerHTML='<option value="">â€” Select Employee â€”</option>';
  Object.keys(empCache).sort().forEach(n=>{
    sel.innerHTML+=`<option value="${n}">${n}</option>`;
  });
  // Also populate portal
  const ps = document.getElementById('portalName');
  ps.innerHTML='<option value="">â€” Select your name â€”</option>';
  Object.keys(empCache).sort().forEach(n=>{
    ps.innerHTML+=`<option value="${n}">${n}</option>`;
  });
}

function fillEmp(){
  const n=g('eNameSel');
  if(n&&empCache[n]){ sv('eName',n); sv('eId',empCache[n]); }
}

function prevPhys(){
  const p=parseInt(g('ePhys'))||0;
  document.getElementById('physAlert').innerHTML = p>0
    ? `<div style="margin-top:.6rem;padding:.6rem .9rem;background:rgba(108,71,255,.1);border-radius:var(--r);font-size:.83rem;color:var(--accent)"><i class="fas fa-info-circle"></i> Adds <b>+${p}</b> to Total Received & Solved.</div>`
    : '';
}

async function genEmpReport(){
  const date=g('eDate'), name=g('eName').trim(), id=g('eId').trim();
  const shift=g('eShift');
  const issues=g('eIssues').trim().split('\n').filter(l=>l.trim());
  const special=g('eSpecial').trim();
  const phys=parseInt(g('ePhys'))||0;
  const proc=g('eSS').trim().split(/\r?\n/).map(l=>l.replace(/"/g,'').trim()).filter(l=>l);

  if(!shift){ toast('Please select a shift','err'); return; }
  if(!name||!id){ toast('Select or fill in employee name','err'); return; }
  if(!issues.length&&!phys){ toast('Enter at least one issue or physical count','err'); return; }

  load('Generating reportâ€¦');
  let rd=new Date(date);
  if(shift==='Night') rd.setDate(rd.getDate()-1);
  const df=rd.toLocaleDateString('en-GB').replace(/\//g,'.');

  const ic={};
  issues.forEach(iss=>{const k=iss.toLowerCase().trim(); ic[k]=(ic[k]||0)+1;});
  const uniq={};
  issues.forEach(i=>{const k=i.toLowerCase().trim(); if(!uniq[k])uniq[k]=i;});

  const totalRec=issues.length+phys, procCnt=proc.length, totalSolv=totalRec-procCnt;
  let r=`Employee Name: ${name}\nEmployee ID: ${id}\nDate: ${df}\nDuty Shift: ${shift}\n`;
  r+=`Total Issues Received: ${totalRec}\nTotal Issues Solved: ${totalSolv}\n`;
  r+=procCnt>0?`Total Issues Processing: ${procCnt} ( ${proc.join(' ')} )\n`:`Total Issues Processing: 0\n`;
  r+=`\n------* Type of Issues *------\n`;
  for(const k in ic) r+=`${uniq[k]}: ${ic[k]}\n`;
  if(phys>0) r+=`Physical Support: ${phys}\n`;
  if(special) r+=`\nâ˜… Special Task/NOTE:\n${special}\n`;

  const out=document.getElementById('eReportOut');
  out.textContent=r; out.style.display='block'; out.classList.add('show');

  try {
    await saveEmpReport({
      date:df, name, employee_id:id, shift,
      issues:totalRec, physical_support:phys, regular_issues:issues.length,
      processing:procCnt, solved:totalSolv, special_task:special, report_content:r
    });
    toast('Report saved to cloud â˜ï¸');
  } catch(e){ toast('Save failed: '+e.message,'err'); }
  hideLoad();
}

// =====================================================
// TL REPORT FORM
// =====================================================
function initTLForm(){
  document.getElementById('tDate').valueAsDate=new Date();
  const out=document.getElementById('tReportOut');
  out.classList.remove('show'); out.style.display='none';
  populateKw();
  updateOv();
  updatePhysPrev();
}

function normalise(t){
  if(!t) return 'UNKNOWN';
  const low=t.toLowerCase();
  for(const[cat,kws] of Object.entries(FIXED)){
    if(kws.some(k=>low.includes(k))) return cat;
  }
  return low.trim();
}

function getCounts(list){
  const c={};
  Object.keys(FIXED).forEach(cat=>c[cat]=0);
  list.forEach(t=>{const n=normalise(t);if(c[n]!==undefined)c[n]++;});
  return c;
}

function populateKw(){
  const el=document.getElementById('kw');
  if(!el)return;
  let h='';
  for(const[cat,kws] of Object.entries(FIXED)){
    h+=`<div style="margin-bottom:.4rem"><b style="font-size:.8rem">${cat}:</b> ${kws.map(k=>`<span class="chip">${k}</span>`).join('')}</div>`;
  }
  el.innerHTML=h;
}

function updateOv(){
  const lines=g('tIssues').split('\n').map(l=>l.trim()).filter(l=>l);
  const counts=getCounts(lines);
  const list=document.getElementById('tlOvList');
  const badge=document.getElementById('ovBadge');
  const rep=Object.entries(counts).filter(([,c])=>c>=3);
  badge.textContent=`${rep.length} repeated`;
  badge.className='badge '+(rep.length>5?'badge-red':rep.length>0?'badge-teal':'badge-gray');
  if(!rep.length){
    list.innerHTML=`<div style="text-align:center;padding:1.5rem;color:var(--muted);font-size:.88rem"><i class="fas fa-check-circle"></i> No repeated issues yet (need â‰¥3)</div>`;
    return;
  }
  list.innerHTML=rep.map(([cat,cnt])=>{
    const cls=cnt>=10?'critical':cnt>=5?'high':'';
    return `<div class="ov-item ${cls}"><span style="font-weight:600;font-size:.9rem">${cat}</span><span class="ov-count ${cls}">Ã—${cnt}</span></div>`;
  }).join('');
}

function updatePhysPrev(){
  const lines=g('tPhys').split('\n').map(l=>l.trim()).filter(l=>l);
  const prev=document.getElementById('physPrev');
  if(!lines.length){prev.style.display='none';return;}
  let comp=0,shift=0,cancel=0;
  lines.forEach(l=>{
    const t=l.toLowerCase();
    if(t.includes('done')||t.includes('complete')||t.includes('fixed')||t.includes('solved'))comp++;
    else if(t.includes('shift')||t.includes('next day')||t.includes('pending'))shift++;
    else if(t.includes('cancel'))cancel++;
  });
  document.getElementById('physGrid').innerHTML=
    physCard(lines.length,'Total','var(--accent)')+physCard(comp,'Complete','var(--green)')+
    physCard(shift,'Shift','var(--gold)')+physCard(cancel,'Cancel','var(--red)');
  prev.style.display='block';
}

function physCard(n,l,c){
  return `<div class="phys-card"><div class="phys-val" style="color:${c}">${n}</div><div class="phys-lbl">${l}</div></div>`;
}

async function genTLReport(){
  const date=g('tDate'), tlName=g('tName'), shift=g('tShift');
  const issues=g('tIssues').trim().split('\n').filter(l=>l.trim());
  const physLines=g('tPhys').trim().split('\n').filter(l=>l.trim());
  const persons=g('tPersons').trim()||'Sakib + labib + Sujan';
  const proc=g('tSS').trim().split(/\r?\n/).map(l=>l.replace(/"/g,'').trim()).filter(l=>l);

  if(!shift){toast('Select a shift','err');return;}
  if(!tlName){toast('Select TL name','err');return;}

  load('Generating TL reportâ€¦');
  let comp=0,shiftC=0,cancel=0;
  physLines.forEach(l=>{
    const t=l.toLowerCase();
    if(t.includes('done')||t.includes('complete')||t.includes('fixed')||t.includes('solved'))comp++;
    else if(t.includes('shift')||t.includes('next day')||t.includes('pending'))shiftC++;
    else if(t.includes('cancel'))cancel++;
  });

  const counts=getCounts(issues);
  const remRec=issues.length, procCnt=proc.length, remSolv=remRec-procCnt;
  const df=new Date(date).toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});
  const st=shift.includes('9:00AM to 6:30PM')?'9:00AM to 6:30PM':shift.includes('9:00AM to 9:00AM')?'9:00AM to 9:00AM':shift;

  let r=`Report: ${df} (${st})\n=============\nRemotely Support>>\n`;
  r+=`Total Issue Rec: ${remRec}\nTotal Issue Solve: ${remSolv}\n`;
  r+=procCnt>0?`Processing: ${procCnt} ( ${proc.join(' ')} )\n`:`Processing: 0\n`;
  r+=`\t\nProcessing: Soft & Sheet Processing Responsible Person : (${persons})\n\n`;
  r+=`Physically Support >>\nTotal Physical: ${physLines.length}\nComplete: ${comp}\nShift: ${shiftC}\nCancel: ${cancel}\n\n`;
  r+=`${st}\n`;

  const disp=['Slow Issues','Solved','Billing Issues','Gaming Issue','Site Browsing Issue','No Internet','Loss','Shifting','New Line'];
  let cbk=issues.filter(i=>i.toLowerCase().includes('call back')).length;
  let any=false;
  disp.forEach(cat=>{
    const c=counts[cat]||0; if(!c)return;
    const n=cat==='Site Browsing Issue'?'site browsing issue':cat==='No Internet'?'No internet':cat;
    r+=`${n}: ${c}\n`; any=true;
  });
  if(cbk>0){r+=`call back: ${cbk}\n`;any=true;}
  if(!any&&remRec>0) r+=`Issues: ${remRec}\n`;
  r+=`Remotely Solved. Details in task.\n\n`;

  const contacts={
    'Safikul Islam':{email:'safikul@saltsync.com',phone:'01901041903'},
    'S.M Faisal':{email:'faisal@saltsync.com',phone:'01901041901'}
  };
  if(contacts[tlName]){
    const c=contacts[tlName];
    r+=`Reported by ${tlName}\nIf you have any query, please knock me anytime.\nEmail: ${c.email}\nCall: ${c.phone}\n-Thanks.\n`;
  }

  const out=document.getElementById('tReportOut');
  out.textContent=r; out.style.display='block'; out.classList.add('show');

  try{
    await saveTLReport({
      date:df, tl_name:tlName, shift, issues:remRec, solved:remSolv, processing:procCnt,
      physical_total:physLines.length, physical_complete:comp, physical_shift:shiftC,
      physical_cancel:cancel, processing_persons:persons, report_content:r
    });
    toast('TL Report saved to cloud â˜ï¸');
  } catch(e){ toast('Save failed: '+e.message,'err'); }
  hideLoad();
}

// =====================================================
// EMPLOYEE PORTAL (view own reports)
// =====================================================
async function initPortal(){
  await refreshEmpCache();
  const ps=document.getElementById('portalName');
  ps.innerHTML='<option value="">â€” Select your name â€”</option>';
  Object.keys(empCache).sort().forEach(n=>{
    ps.innerHTML+=`<option value="${n}">${n}</option>`;
  });
}

async function loadPortal(){
  const name=g('portalName');
  if(!name){
    document.getElementById('portalList').innerHTML=`<div class="report-empty"><i class="fas fa-user-circle"></i><p>Select your name to view reports</p></div>`;
    return;
  }
  load('Loading your reportsâ€¦');
  try{
    const all=await fetchAllEmpReports();
    const mine=all.filter(r=>r.name===name);
    hideLoad();
    if(!mine.length){
      document.getElementById('portalList').innerHTML=`<div class="report-empty"><i class="fas fa-inbox"></i><p>No reports found for <b>${name}</b></p></div>`;
      return;
    }
    document.getElementById('portalList').innerHTML=mine.map(r=>`
      <div class="portal-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:.5rem">
          <div>
            <div class="portal-report-date"><i class="fas fa-calendar" style="color:var(--accent);margin-right:.4rem"></i>${r.date} Â· ${r.shift} Shift</div>
            <div class="portal-meta">
              <span class="badge badge-purple">ðŸ“‹ ${r.issues} Issues</span>
              <span class="badge badge-teal">âœ… ${r.solved} Solved</span>
              ${r.processing>0?`<span class="badge badge-gold">â³ ${r.processing} Processing</span>`:''}
              ${r.physical_support>0?`<span class="badge badge-green">ðŸ”§ ${r.physical_support} Physical</span>`:''}
            </div>
            ${r.special_task?`<div style="font-size:.85rem;color:var(--gold);margin-top:.3rem"><i class="fas fa-star"></i> ${r.special_task.slice(0,80)}${r.special_task.length>80?'â€¦':''}</div>`:''}
          </div>
          <button class="nav-btn btn-ghost" style="padding:.4rem .9rem;font-size:.82rem" onclick='openModal(${JSON.stringify(r.report_content)})'><i class="fas fa-eye"></i> View</button>
        </div>
      </div>`).join('');
  } catch(e){
    hideLoad();
    toast('Error loading reports: '+e.message,'err');
  }
}

// =====================================================
// ADMIN PANEL
// =====================================================
async function loadAdminPanel(){
  if(!isAdmin){ goTo('adminGate'); return; }
  // Update DB info
  document.getElementById('dbStatusBadge').textContent = db.mode==='cloud'?'Connected':'Local';
  document.getElementById('dbStatusBadge').className = 'badge '+(db.mode==='cloud'?'badge-teal':'badge-gold');
  document.getElementById('dbModeBadge').textContent = db.mode==='cloud'?'Cloud (JSONBin)':'Local Browser';
  // Load data
  load('Loading reportsâ€¦');
  try{
    allEmpReports = await fetchAllEmpReports();
    allTLReports  = await fetchAllTLReports();
    hideLoad();
    renderEmpTable(allEmpReports);
    renderTLTable(allTLReports);
    updateStats();
    await loadEmpMgmt();
    // notification
    const s=await getSettings();
    sv('notifInput', s.notification||'');
    document.getElementById('dbCountBadge').textContent = (allEmpReports.length+allTLReports.length)+' records';
  } catch(e){ hideLoad(); toast('Error: '+e.message,'err'); }
}

function updateStats(){
  document.getElementById('st0').textContent=allEmpReports.length;
  document.getElementById('st1').textContent=allTLReports.length;
  document.getElementById('st2').textContent=allEmpReports.reduce((a,r)=>a+(r.issues||0),0)+allTLReports.reduce((a,r)=>a+(r.issues||0),0);
  document.getElementById('st3').textContent=allEmpReports.reduce((a,r)=>a+(r.solved||0),0)+allTLReports.reduce((a,r)=>a+(r.solved||0),0);
}

// â”€â”€ EMPLOYEE REPORTS TABLE â”€â”€
function renderEmpTable(data){
  const tb=document.getElementById('empTBody');
  if(!data.length){
    tb.innerHTML=`<tr><td colspan="8"><div class="report-empty"><i class="fas fa-inbox"></i><p>No employee reports yet</p></div></td></tr>`;
    return;
  }
  tb.innerHTML=data.map(r=>`
    <tr>
      <td><b>${r.date}</b></td>
      <td>${r.name}<br><small style="color:var(--muted)">${r.employee_id}</small></td>
      <td><span class="badge badge-gray">${r.shift}</span></td>
      <td><span class="badge badge-purple">${r.issues}</span></td>
      <td><span class="badge badge-teal">${r.solved}</span></td>
      <td>${r.physical_support>0?`<span class="badge badge-green">${r.physical_support}</span>`:'-'}</td>
      <td>${r.special_task?'<i class="fas fa-star" style="color:var(--gold)"></i>':'-'}</td>
      <td style="white-space:nowrap">
        <button class="nav-btn btn-ghost" style="padding:.35rem .7rem;font-size:.8rem;margin-right:.35rem" onclick='openModal(${JSON.stringify(r.report_content)})'><i class="fas fa-eye"></i></button>
        <button class="nav-btn btn-danger" style="padding:.35rem .7rem;font-size:.8rem" onclick="delReport('emp','${r.id}')"><i class="fas fa-trash"></i></button>
      </td>
    </tr>`).join('');
}

function filterEmpTable(){
  const q=g('empSearch').toLowerCase();
  renderEmpTable(allEmpReports.filter(r=>(r.name||'').toLowerCase().includes(q)||(r.date||'').toLowerCase().includes(q)));
}

// â”€â”€ TL REPORTS TABLE â”€â”€
function renderTLTable(data){
  const tb=document.getElementById('tlTBody');
  if(!data.length){
    tb.innerHTML=`<tr><td colspan="8"><div class="report-empty"><i class="fas fa-inbox"></i><p>No TL reports yet</p></div></td></tr>`;
    return;
  }
  tb.innerHTML=data.map(r=>`
    <tr>
      <td><b>${r.date}</b></td>
      <td>${r.tl_name}</td>
      <td><span class="badge badge-gray">${r.shift}</span></td>
      <td><span class="badge badge-purple">${r.issues}</span></td>
      <td><span class="badge badge-teal">${r.solved}</span></td>
      <td><span class="badge badge-green">${r.physical_total||0}</span></td>
      <td><span class="badge badge-gold">${r.processing||0}</span></td>
      <td style="white-space:nowrap">
        <button class="nav-btn btn-ghost" style="padding:.35rem .7rem;font-size:.8rem;margin-right:.35rem" onclick='openModal(${JSON.stringify(r.report_content)})'><i class="fas fa-eye"></i></button>
        <button class="nav-btn btn-danger" style="padding:.35rem .7rem;font-size:.8rem" onclick="delReport('tl','${r.id}')"><i class="fas fa-trash"></i></button>
      </td>
    </tr>`).join('');
}

function filterTLTable(){
  const q=g('tlSearch').toLowerCase();
  renderTLTable(allTLReports.filter(r=>(r.tl_name||'').toLowerCase().includes(q)||(r.date||'').toLowerCase().includes(q)));
}

// â”€â”€ DELETE REPORT â”€â”€
async function delReport(type, id){
  if(!confirm('Delete this report permanently?')) return;
  load('Deletingâ€¦');
  try{
    await deleteReport(type, id);
    if(type==='emp') allEmpReports=allEmpReports.filter(r=>r.id!==id), renderEmpTable(allEmpReports);
    else allTLReports=allTLReports.filter(r=>r.id!==id), renderTLTable(allTLReports);
    updateStats();
    hideLoad(); toast('Report deleted');
  } catch(e){ hideLoad(); toast('Delete failed: '+e.message,'err'); }
}

// â”€â”€ EMPLOYEES MANAGEMENT â”€â”€
async function loadEmpMgmt(){
  await refreshEmpCache();
  const el=document.getElementById('empList');
  const names=Object.keys(empCache).sort();
  if(!names.length){el.innerHTML=`<div class="report-empty"><i class="fas fa-user-slash"></i><p>No employees yet</p></div>`;return;}
  el.innerHTML=names.map(n=>`
    <div class="emp-item">
      <div><div class="emp-name">${n}</div><div class="emp-id"><i class="fas fa-id-badge" style="margin-right:.3rem"></i>${empCache[n]}</div></div>
      <button class="nav-btn btn-danger" style="padding:.35rem .75rem;font-size:.8rem" onclick="removeEmp('${n}')"><i class="fas fa-trash"></i></button>
    </div>`).join('');
}

async function addEmployee(){
  const name=g('newEName').trim(), id=g('newEId').trim();
  if(!name||!id){toast('Enter both name and ID','err');return;}
  load('Adding employeeâ€¦');
  try{
    await addEmpToDB(name, id);
    sv('newEName',''); sv('newEId','');
    await loadEmpMgmt();
    hideLoad(); toast(`${name} added!`);
  } catch(e){ hideLoad(); toast(e.message,'err'); }
}

async function removeEmp(name){
  if(!confirm(`Remove ${name} from the system?`)) return;
  load('Removingâ€¦');
  try{
    await removeEmpFromDB(name);
    await loadEmpMgmt();
    hideLoad(); toast(`${name} removed`);
  } catch(e){ hideLoad(); toast('Error: '+e.message,'err'); }
}

// â”€â”€ NOTIFICATION â”€â”€
async function saveNotif(){
  const txt=g('notifInput').trim();
  if(!txt){toast('Enter notification text','err');return;}
  load('Savingâ€¦');
  try{
    await saveSettings({notification:txt});
    document.getElementById('notifTxt').textContent=txt;
    hideLoad(); toast('Notification updated & live!');
  } catch(e){ hideLoad(); toast('Error: '+e.message,'err'); }
}

function previewNotif(){
  document.getElementById('notifTxt').textContent=g('notifInput')||'(empty)';
  toast('Preview shown in banner','info');
}

// â”€â”€ PASSWORD â”€â”€
async function changePwd(){
  const cur=g('curPwd'), np=g('newPwd'), np2=g('newPwd2');
  if(cur!==getAdminPass()){toast('Current password is wrong','err');return;}
  if(np.length<4){toast('New password must be at least 4 characters','err');return;}
  if(np!==np2){toast('Passwords do not match','err');return;}
  load('Updating passwordâ€¦');
  try{
    await saveSettings({adminPass:np});
    sv('curPwd',''); sv('newPwd',''); sv('newPwd2','');
    hideLoad(); toast('Password updated successfully!');
  } catch(e){ hideLoad(); toast('Error: '+e.message,'err'); }
}

async function resetPwd(){
  if(!confirm('Reset admin password to "admin"?')) return;
  load('Resettingâ€¦');
  try{
    await saveSettings({adminPass:'admin'});
    hideLoad(); toast('Password reset to "admin"');
  } catch(e){ hideLoad(); toast('Error: '+e.message,'err'); }
}

// â”€â”€ DB SETTINGS â”€â”€
async function reconnectDB(){
  const key=g('newCfgKey').trim();
  if(!key){toast('Enter new API key','err');return;}
  const cfg=getCfg();
  if(cfg){ cfg.key=key; localStorage.setItem(CFG_KEY,JSON.stringify(cfg)); }
  toast('Key updated. Reloadingâ€¦','info');
  setTimeout(()=>location.reload(),1000);
}

function clearConfig(){
  if(!confirm('This will remove cloud config and go back to setup. Continue?')) return;
  localStorage.removeItem(CFG_KEY);
  localStorage.removeItem(LOCAL_KEY);
  location.reload();
}

// â”€â”€ TAB SWITCH â”€â”€
function switchTab(id){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.currentTarget.classList.add('active');
}

// =====================================================
// MODAL
// =====================================================
function openModal(content){
  document.getElementById('modalContent').textContent=content;
  document.getElementById('reportModal').classList.add('open');
}

function closeModal(e){
  if(!e||e.target===document.getElementById('reportModal')||e.currentTarget.classList?.contains('modal-close')){
    document.getElementById('reportModal').classList.remove('open');
  }
}

function copyModalContent(){
  navigator.clipboard.writeText(document.getElementById('modalContent').textContent)
    .then(()=>toast('Copied to clipboard!'));
}

// =====================================================
// UTILITIES
// =====================================================
function g(id){ return (document.getElementById(id)||{}).value||''; }
function sv(id,v){ const el=document.getElementById(id); if(el)el.value=v; }
function getLocal(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch{return [];} }
function saveLocal(k,v){ localStorage.setItem(k,JSON.stringify(v)); }

function copyOut(id){
  const t=document.getElementById(id).textContent;
  if(!t||t.includes('Report will')){ toast('Generate a report first','err'); return; }
  navigator.clipboard.writeText(t).then(()=>toast('Copied!')).catch(()=>toast('Copy failed','err'));
}

function toast(msg, type='ok'){
  const div=document.createElement('div');
  div.className=`toast-item ${type}`;
  const icon=type==='ok'?'fa-check-circle':type==='err'?'fa-exclamation-circle':'fa-info-circle';
  div.innerHTML=`<i class="fas ${icon}"></i><span style="flex:1">${msg}</span><button onclick="this.parentElement.remove()" style="background:none;border:none;color:inherit;cursor:pointer;font-size:.9rem;opacity:.7"><i class="fas fa-times"></i></button>`;
  document.getElementById('toastArea').appendChild(div);
  setTimeout(()=>{ div.style.opacity='0'; div.style.transform='translateX(200px)'; setTimeout(()=>div.remove(),300); }, 4000);
}

function load(txt='Processingâ€¦'){
  document.getElementById('loaderTxt').textContent=txt;
  document.getElementById('loader').classList.add('on');
}
function hideLoad(){ document.getElementById('loader').classList.remove('on'); }

function setPill(cls,txt){
  const p=document.getElementById('cloudPill');
  p.className='nav-pill'+(cls?' '+cls:'');
  const icon=cls==='ok'?'fa-cloud-upload-alt':cls==='err'?'fa-exclamation-triangle':'fa-wifi';
  p.innerHTML=`<span class="nav-dot"></span> ${txt}`;
}

function toggleTheme(){
  const html=document.documentElement;
  const isDark=html.getAttribute('data-theme')==='dark';
  const icon=document.getElementById('themeIcon');
  if(isDark){ html.removeAttribute('data-theme'); icon.className='fas fa-moon'; localStorage.setItem('srp_theme','light'); }
  else { html.setAttribute('data-theme','dark'); icon.className='fas fa-sun'; localStorage.setItem('srp_theme','dark'); }
}

function loadTheme(){
  const t=localStorage.getItem('srp_theme');
  if(t==='dark'){ document.documentElement.setAttribute('data-theme','dark'); document.getElementById('themeIcon').className='fas fa-sun'; }
}
</script>
</body>
</html>
